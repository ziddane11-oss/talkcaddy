'use strict';var h=/(\*\*)([^*]*?)$/,k=/(__)([^_]*?)$/,p=/(\*\*\*)([^*]*?)$/,m=/(\*)([^*]*?)$/,I=/(_)([^_]*?)$/,b=/(`)([^`]*?)$/,M=/(~~)([^~]*?)$/,l=/^[\s_~*`]*$/,g=/^[\s]*[-*+][\s]+$/,B=/[\p{L}\p{N}_]/u,$=/^```[^`\n]*```?$/,P=/^\*{4,}$/;var c=n=>{if(!n)return  false;let r=n.charCodeAt(0);return r>=48&&r<=57||r>=65&&r<=90||r>=97&&r<=122||r===95?true:B.test(n)},u=n=>{let r=(n.match(/```/g)||[]).length;return r>0&&r%2===0&&n.includes(`
`)},A=(n,r)=>{let e=1;for(let t=r-1;t>=0;t-=1)if(n[t]==="]")e+=1;else if(n[t]==="["&&(e-=1,e===0))return t;return  -1},C=(n,r)=>{let e=1;for(let t=r+1;t<n.length;t+=1)if(n[t]==="[")e+=1;else if(n[t]==="]"&&(e-=1,e===0))return t;return  -1},d=(n,r)=>{let e=false,t=false;for(let s=0;s<n.length&&s<r;s+=1){if(n[s]==="\\"&&n[s+1]==="$"){s+=1;continue}n[s]==="$"&&(n[s+1]==="$"?(t=!t,s+=1,e=false):t||(e=!e));}return e||t};var R=(n,r,e)=>{if(e!==" "&&e!=="	")return  false;let t=0;for(let s=r-1;s>=0;s-=1)if(n[s]===`
`){t=s+1;break}for(let s=t;s<r;s+=1)if(n[s]!==" "&&n[s]!=="	")return  false;return  true},y=(n,r,e,t)=>!!(e==="\\"||e==="*"||t==="*"||e&&t&&c(e)&&c(t)||R(n,r,t)),E=n=>{let r=0,e=n.length;for(let t=0;t<e;t+=1){if(n[t]!=="*")continue;let s=t>0?n[t-1]:"",i=t<e-1?n[t+1]:"";y(n,t,s,i)||(r+=1);}return r},j=(n,r,e,t)=>!!(e==="\\"||n.includes("$")&&d(n,r)||e==="_"||t==="_"||e&&t&&c(e)&&c(t)),q=n=>{let r=0,e=n.length;for(let t=0;t<e;t+=1){if(n[t]!=="_")continue;let s=t>0?n[t-1]:"",i=t<e-1?n[t+1]:"";j(n,t,s,i)||(r+=1);}return r},z=n=>{let r=0,e=0;for(let t=0;t<n.length;t+=1)n[t]==="*"?e+=1:(e>=3&&(r+=Math.floor(e/3)),e=0);return e>=3&&(r+=Math.floor(e/3)),r},S=n=>{if(u(n))return n;let r=n.match(h);if(r){let e=r[2];if(!e||l.test(e))return n;let t=n.lastIndexOf(r[1]),i=n.substring(0,t).lastIndexOf(`
`),o=i===-1?0:i+1,a=n.substring(o,t);if(g.test(a)&&e.includes(`
`))return n;if((n.match(/\*\*/g)||[]).length%2===1)return `${n}**`}return n},U=n=>{let r=n.match(k);if(r){let e=r[2];if(!e||l.test(e))return n;let t=n.lastIndexOf(r[1]),i=n.substring(0,t).lastIndexOf(`
`),o=i===-1?0:i+1,a=n.substring(o,t);if(g.test(a)&&e.includes(`
`))return n;if((n.match(/__/g)||[]).length%2===1)return `${n}__`}return n},G=n=>{for(let r=0;r<n.length;r+=1)if(n[r]==="*"&&n[r-1]!=="*"&&n[r+1]!=="*"&&n[r-1]!=="\\"){let e=r>0?n[r-1]:"",t=r<n.length-1?n[r+1]:"";if(e&&t&&c(e)&&c(t))continue;return r}return  -1},w=n=>{if(u(n)||!n.match(m))return n;let e=G(n);if(e===-1)return n;let t=n.substring(e+1);return !t||l.test(t)?n:E(n)%2===1?`${n}*`:n},H=n=>{for(let r=0;r<n.length;r+=1)if(n[r]==="_"&&n[r-1]!=="_"&&n[r+1]!=="_"&&n[r-1]!=="\\"&&!d(n,r)){let e=r>0?n[r-1]:"",t=r<n.length-1?n[r+1]:"";if(e&&t&&c(e)&&c(t))continue;return r}return  -1},J=n=>{let r=n.length;for(;r>0&&n[r-1]===`
`;)r-=1;if(r<n.length){let e=n.slice(0,r),t=n.slice(r);return `${e}_${t}`}return `${n}_`},_=n=>{if(u(n)||!n.match(I))return n;let e=H(n);if(e===-1)return n;let t=n.substring(e+1);return !t||l.test(t)?n:q(n)%2===1?J(n):n},O=n=>{if(u(n)||P.test(n))return n;let r=n.match(p);if(r){let e=r[2];if(!e||l.test(e))return n;if(z(n)%2===1)return `${n}***`}return n};var f=(n,r)=>{let e=false,t=false;for(let s=0;s<r;s+=1){if(n.substring(s,s+3)==="```"){t=!t,s+=2;continue}!t&&n[s]==="`"&&(e=!e);}return e||t},Q=(n,r)=>{let e=n.substring(r,r+3)==="```",t=r>0&&n.substring(r-1,r+2)==="```",s=r>1&&n.substring(r-2,r+1)==="```";return e||t||s},T=n=>{let r=0;for(let e=0;e<n.length;e+=1)n[e]==="`"&&!Q(n,e)&&(r+=1);return r};var V=n=>!n.match($)||n.includes(`
`)?null:n.endsWith("``")&&!n.endsWith("```")?`${n}\``:n,X=n=>{let r=(n.match(/```/g)||[]).length;return !!(r>0&&r%2===0&&n.includes(`
`)||(n.endsWith("```\n")||n.endsWith("```"))&&r%2===0)},Y=n=>(n.match(/```/g)||[]).length%2===1,N=n=>{let r=V(n);if(r!==null)return r;if(X(n))return n;let e=n.match(b);if(e&&!Y(n)){let t=e[2];if(!t||l.test(t))return n;if(T(n)%2===1)return `${n}\``}return n};var W=n=>{if((n.match(/\$\$/g)||[]).length%2===0)return n;let e=n.indexOf("$$");return e!==-1&&n.indexOf(`
`,e)!==-1&&!n.endsWith(`
`)?`${n}
$$`:`${n}$$`};var Z=(n,r)=>{if(n.substring(r+2).includes(")"))return null;let t=A(n,r);if(t===-1||f(n,t))return null;let s=t>0&&n[t-1]==="!",i=s?t-1:t,o=n.substring(0,i);if(s)return o;let a=n.substring(t+1,r);return `${o}[${a}](streamdown:incomplete-link)`},v=(n,r)=>{let e=r>0&&n[r-1]==="!",t=e?r-1:r;if(!n.substring(r+1).includes("]")){let o=n.substring(0,t);return e?o:`${n}](streamdown:incomplete-link)`}if(C(n,r)===-1){let o=n.substring(0,t);return e?o:`${n}](streamdown:incomplete-link)`}return null},L=n=>{let r=n.lastIndexOf("](");if(r!==-1&&!f(n,r)){let e=Z(n,r);if(e!==null)return e}for(let e=n.length-1;e>=0;e-=1)if(n[e]==="["&&!f(n,e)){let t=v(n,e);if(t!==null)return t}return n};var F=n=>{let r=n.match(M);if(r){let e=r[2];if(!e||l.test(e))return n;if((n.match(/~~/g)||[]).length%2===1)return `${n}~~`}return n};var x=n=>{if(!n||typeof n!="string")return n;let r=n,e=L(r);return e.endsWith("](streamdown:incomplete-link)")?e:(r=e,r=O(r),r=S(r),r=U(r),r=w(r),r=_(r),r=N(r),r=F(r),r=W(r),r)},$n=x;module.exports=$n;